<!--
title: La Ruota dei sentori olfattivi
description: 
published: true
date: 2022-01-18T15:05:39.033Z
tags: 
editor: code
dateCreated: 2022-01-18T14:42:09.425Z
-->

<div id="my_dataviz"></div>

<script>
  // set the dimensions and margins of the graph
  const margin = {top: 20, right: 10, bottom: 30, left: 10},
      width = 930 - margin.left - margin.right,
      height = 930 - margin.top - margin.bottom,
      innerRadius = 1,
      outerRadius = Math.min(width, height) /1.6;   
      familiesOuterRadius = outerRadius - 120
      familiesInnerRadius = outerRadius - 105

  // append the svg object
  const svg = d3.select("#my_dataviz")
    .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", `translate(${width/2+margin.left}, ${height/2+margin.top})`);
  const myColor = d3.scaleOrdinal().domain([1,2,3,4,5,6,7,8,9])
        .range(["#80b1d3", "#e66e6d", "#c5d551", "#d0d1cb", "#f9c91d", "#a27859", "#e94235", "#cf9fd6", "#2a2e32"]);  
  const colorScale =  function(d){

     if (d.Valore != 100){
       return('black')
      } else {
        return(myColor(d.Famiglia))
      }
    };

  d3.csv("/_assets/data/listone.csv").then( function(data) {

    const x = d3.scaleBand()
        .range([0, 2 * Math.PI])    // X axis goes from 0 to 2pi = all around the circle. If I stop at 1Pi, it will be around a half circle
        .align(0)                  // This does nothing
        .domain(data.map(d => d.Sentore)); // The domain of the X axis is the list of states.
    const y = d3.scaleRadial()
        .range([innerRadius, outerRadius])   // Domain will be define later.
        .domain([0, 300]); // Domain of Y is from 0 to the max seen in the data

      svg.append("g")
      .selectAll("path")
      .data(data)
      .join("path")
        .attr("id", function(d){return(d.Sentore.replaceAll(' ', '_').toLowerCase())})
        .attr("fill", colorScale  )
        //.attr("fill", function(d){return(d.Valore)})
        .attr("d", d3.arc()     // imagine your doing a part of a donut plot
            .innerRadius(innerRadius)
            .outerRadius(d => y(d['Valore']))
            .startAngle(d => x(d.Sentore))
            .endAngle(d => x(d.Sentore) + x.bandwidth())
            .padAngle(0.01)
            .padRadius(innerRadius))

      // Add the labels
      svg.append("g")
      .selectAll("g")
      .data(data)
      .join("g")
        .attr("text-anchor", function(d) { return (x(d.Sentore) + x.bandwidth() / 2 + Math.PI) % (2 * Math.PI) < Math.PI ? "end" : "start"; })
        /* conditional applied with the same condition that sets the anchor in the previous attr, so that when text-anchor is "end" we can subtract 92, when is "start we can subtract 88". Without this hack labels are not perfectly centered*/
        .attr("transform", function(d) { return (x(d.Sentore) + x.bandwidth() / 2 + Math.PI) % (2 * Math.PI) < Math.PI ? "rotate(" + ((x(d.Sentore) + x.bandwidth() / 2) * 180 / Math.PI - 90.5) + ")"+"translate(" + (100) + ",0)" : "rotate(" + ((x(d.Sentore) + x.bandwidth() / 2) * 180 / Math.PI - 89.5) + ")"+"translate(" + (100) + ",0)"; }
        // the following is the original function used to position labels: 
        /*function(d) { return "rotate(" + ((x(d.Sentore) + x.bandwidth() / 2) * 180 / Math.PI - 90) + ")"+"translate(" + (100) + ",0)";}
        */)
      .append("text")
        .text(function(d){return(d.Sentore)})
        .attr("transform", function(d) { return (x(d.Sentore) + x.bandwidth() / 2 + Math.PI) % (2 * Math.PI) < Math.PI ? "rotate(180)" : "rotate(0)"; })
        .attr("x", function(d) { return (x(d.Sentore) + x.bandwidth() / 2 + Math.PI) % (2 * Math.PI) < Math.PI ? "-230" : "230"; })
        .style("font-size", "11px")
        .attr("fill", colorScale)
        .attr("alignment-baseline", "middle")


  });

  var floreale = d3.arc()
    .innerRadius(familiesInnerRadius)
    .outerRadius(familiesOuterRadius)
    .startAngle(0.001 * Math.PI)
    .endAngle(0.285 * Math.PI);
  svg.append("path")
    .attr("d", floreale)
    .attr("fill", myColor(1))
    .attr("id", "floreale");
    svg.append("text")
      .attr("dy", 13)
      .append("textPath") 
        .attr("xlink:href", "#floreale")
        .attr("fill", "white")
        .style("font-weight", "bold")  
        .style("text-anchor","middle") 
        .attr("startOffset", "25%")
        .text("FLOREALE");
  var fruttato = d3.arc()   
    .innerRadius(familiesInnerRadius)
    .outerRadius(familiesOuterRadius)
    .startAngle(0.285 * Math.PI)
    .endAngle(0.845 * Math.PI);
  svg.append("path")
    .attr("d", fruttato)
    .attr("fill", myColor(2) )
    .attr("id", "fruttato");
    svg.append("text")
      .attr("dy", 13)
      .append("textPath") 
        .attr("xlink:href", "#fruttato")
        .attr("fill", "white")
        .style("font-weight", "bold") 
        .style("text-anchor","middle") 
        .attr("startOffset", "25%")
        .text("FRUTTATO");
  var vegetale = d3.arc()   
    .innerRadius(familiesInnerRadius)
    .outerRadius(familiesOuterRadius)
    .startAngle(0.845 * Math.PI)
    .endAngle(1.150 * Math.PI);
  svg.append("path")
    .attr("d", vegetale)
    .attr("fill", myColor(3))
    .attr("id", "vegetale");
    svg.append("text")
      .attr("dy", 13)
      .append("textPath") 
        .attr("xlink:href", "#vegetale")
        .attr("fill", "white")
        .style("font-weight", "bold") 
        .style("text-anchor","middle") 
        .attr("startOffset", "25%")
        .text("VEGETALE");        
  var minerale = d3.arc()   
    .innerRadius(familiesInnerRadius)
    .outerRadius(familiesOuterRadius)
    .startAngle(1.150 * Math.PI)
    .endAngle(1.270 * Math.PI);
  svg.append("path")
    .attr("d", minerale)
    .attr("fill", myColor(4))
    .attr("id", "minerale");
    svg.append("text")
      .attr("dy", 13)
      .append("textPath") 
        .attr("xlink:href", "#minerale")
        .attr("fill", "white")
        .style("font-weight", "bold") 
        .style("text-anchor","middle") 
        .attr("startOffset", "25%")
        .text("MINERALE");
  var speziato = d3.arc()   
    .innerRadius(familiesInnerRadius)
    .outerRadius(familiesOuterRadius)
    .startAngle(1.270 * Math.PI)
    .endAngle(1.415 * Math.PI);
  svg.append("path")
    .attr("d", speziato)
    .attr("fill", myColor(5))
    .attr("id", "speziato");
    svg.append("text")
      .attr("dy", 13)
      .append("textPath") 
        .attr("xlink:href", "#speziato")
        .attr("fill", "white")
        .style("font-weight", "bold") 
        .style("text-anchor","middle") 
        .attr("startOffset", "25%")
        .text("SPEZIATO");
  var tostato = d3.arc()   
    .innerRadius(familiesInnerRadius)
    .outerRadius(familiesOuterRadius)
    .startAngle(1.415 * Math.PI)
    .endAngle(1.530 * Math.PI);
  svg.append("path")
    .attr("d", tostato)
    .attr("fill", myColor(6))
    .attr("id", "tostato");
    svg.append("text")
      .attr("dy", 13)
      .append("textPath") 
        .attr("xlink:href", "#tostato")
        .attr("fill", "white")
        .style("font-weight", "bold") 
        .style("text-anchor","middle") 
        .attr("startOffset", "25%")
        .text("TOSTATO");
  var animale = d3.arc()   
    .innerRadius(familiesInnerRadius)
    .outerRadius(familiesOuterRadius)
    .startAngle(1.530 * Math.PI)
    .endAngle(1.585 * Math.PI);
  svg.append("path")
    .attr("d", animale)
    .attr("fill", myColor(7))
    .attr("id", "animale");
    svg.append("text")
      .attr("dy", 13)
      .append("textPath") 
        .attr("xlink:href", "#animale")
        .attr("fill", "white")
        .style("font-weight", "bold") 
        .style("text-anchor","middle") 
        .attr("startOffset", "22%")
        .text("ANIMALE");
  var etereo = d3.arc()   
    .innerRadius(familiesInnerRadius)
    .outerRadius(familiesOuterRadius)
    .startAngle(1.585 * Math.PI)
    .endAngle(1.655 * Math.PI);
  svg.append("path")
    .attr("d", etereo)
    .attr("fill", myColor(8))
    .attr("id", "etereo");
    svg.append("text")
      .attr("dy", 13)
      .append("textPath") 
        .attr("xlink:href", "#etereo")
        .attr("fill", "white")
        .style("font-weight", "bold") 
        .style("text-anchor","middle") 
        .attr("startOffset", "25%")
        .text("ETEREO");
  var altri = d3.arc()   
    .innerRadius(familiesInnerRadius)
    .outerRadius(familiesOuterRadius)
    .startAngle(1.655 * Math.PI)
    .endAngle(2 * Math.PI);
  svg.append("path")
    .attr("d", altri)
    .attr("fill", myColor(9))
    .attr("id", "altri");
    svg.append("text")
      .attr("dy", 13)
      .append("textPath") 
        .attr("xlink:href", "#altri")
        .attr("fill", "white")
        .style("font-weight", "bold") 
        .style("text-anchor","middle") 
        .attr("startOffset", "25%")
        .text("ALTRI");        
</script>